---
title: "Analysis"
format: html
jupyter: python3
---

```{python}
%matplotlib inline
import matplotlib_inline
matplotlib_inline.backend_inline.set_matplotlib_formats('svg')

from pf2barcode.imports import import_CCLE
from anndata import AnnData
import scanpy as sc
import pandas as pd

X = import_CCLE("dev_pca")
X.obs["SW"] = pd.Categorical(X.obs["SW"])

# Get rid of cells with no barcode
X = X[X.obs["SW"] != "unknown"]

# remove cells with barcodes having less than 10 cells
good_SW = X.obs["SW"].value_counts().index[X.obs["SW"].value_counts() > 5]
X = X[X.obs["SW"].isin(good_SW)]

pcadata = AnnData(X.obsm["X_pca"], obs=X.obs, var=pd.DataFrame(index=[f'PC{i}' for i in range(1, X.obsm["X_pca"].shape[1] + 1)]))
pcadata.X /= pcadata.X.mean(axis=1, keepdims=True)

sc.tl.dendrogram(pcadata, groupby="SW", inplace=True, optimal_ordering=True)
sc.pl.heatmap(pcadata, pcadata.var_names, groupby="SW", dendrogram=True, vmax=20.0, vmin=-20.0, cmap="PiYG")
```

```{python}
from pf2barcode.analysis import anova_pvalues
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

pvalues = anova_pvalues(X)
sns.barplot(x=np.arange(pvalues.shape[0]), y=-np.log10(pvalues))
plt.xlabel("PC")
plt.ylabel("-log10(p-value)")
```
